name: Package and Publish
run-name : ${{ github.actor }} is running Package and Publish
on: [push, pull_request]

defaults:
  run:
    shell: pwsh

jobs:
  check-vsce-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - run: npm install -g @vscode/vsce
        shell: bash
      - run: vsce -V
        shell: bash
      - id: get-suffix
        name: Get package version suffix
        run: |
          $packageVersionSuffix = ""

          $branchName = ""
          if ($env:GITHUB_REF -match "refs/heads/(.*)") {
            $branchName = $Matches[1]
          }

          if ($branchName -eq "master" -or $branchName -eq "main") {
            echo "This is the default branch, so no package version suffix will be used."
          } else {
            $packageVersionSuffix = "preview-$env:GITHUB_RUN_NUMBER.$env:GITHUB_RUN_ATTEMPT.$env:GITHUB_RUN_ID"
            echo "This is not the default branch, so a package version suffix: [$packageVersionSuffix] will be used."
          }

          echo "package-version-suffix=$packageVersionSuffix" >> $env:GITHUB_OUTPUT
      

